<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åæ‡‰æ™‚é–“å°éŠæˆ²ï½œå‡ºç¾æˆ–æ¶ˆå¤±å°±æŒ‰ç©ºç™½éµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14;
      --fg:#e6edf3;
      --muted:#9fb3c8;
      --accent:#60d394;   /* ç¶ ï¼šå¯æŒ‰ */
      --warn:#ffb020;     /* æ©˜ï¼šç­‰å¾… */
      --bad:#ff6b6b;      /* ç´…ï¼šå½èµ·è·‘ */
      --card:#111826;
      --cardBorder:#203042;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f6f8fb;
        --fg:#0f1720;
        --muted:#516073;
        --accent:#1fb672;
        --warn:#c07a07;
        --bad:#d93838;
        --card:#ffffff;
        --cardBorder:#e6ecf3;
      }
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    .wrap{
      max-width:900px; margin:0 auto; padding:24px;
      display:flex; flex-direction:column; gap:16px;
    }
    h1{ margin:0; font-size:26px; letter-spacing:0.5px; }
    .subtitle{ color:var(--muted); font-size:14px }
    .board{
      border:1px solid var(--cardBorder);
      border-radius:16px;
      background:var(--card);
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:16px;
    }
    @media (max-width: 860px){
      .board{ grid-template-columns: 1fr; }
    }
    .stage{
      aspect-ratio: 16/10;
      border:1px dashed var(--cardBorder);
      border-radius:12px;
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
      user-select:none;
      cursor:pointer;
    }
    .status{
      position:absolute; top:12px; left:12px;
      font-size:14px; color:var(--muted);
      background:rgba(0,0,0,0.12);
      padding:6px 10px; border-radius:999px;
    }
    .stim{
      width:min(40vmin,260px); height:min(40vmin,260px);
      border-radius:20px;
      display:grid; place-items:center;
      font-weight:700;
      transition: opacity 140ms ease, transform 140ms ease, background 140ms ease;
      background:#32445a; color:#fff; opacity:0.85;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .stim.hidden{ opacity:0; transform: scale(0.92); pointer-events:none; }
    .stim.ready{ background:var(--accent); }
    .stim.wait{ background:var(--warn); }
    .stim.false{ background:var(--bad); }
    .panel{
      border:1px solid var(--cardBorder);
      border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px;
      background:linear-gradient(180deg, rgba(96, 211, 148, .06), rgba(0,0,0,0));
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .stat{ background:rgba(255,255,255,0.05); border:1px solid var(--cardBorder); border-radius:10px; padding:10px 12px; min-width:110px }
    .stat .label{ color:var(--muted); font-size:12px }
    .stat .val{ font-size:20px; font-weight:700 }
    .btn{
      border:1px solid var(--cardBorder); background:var(--card);
      padding:10px 14px; border-radius:10px; color:var(--fg);
      font-weight:600; cursor:pointer;
      transition: transform .05s ease, background .2s ease;
    }
    .btn:hover{ background:rgba(255,255,255,.04) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:transparent; color:#0b1a12 }
    .hint{ color:var(--muted); font-size:13px; line-height:1.6 }
    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background:#0c131d; color:#b6cff1;
      border:1px solid var(--cardBorder); border-radius:10px; padding:10px; height:140px; overflow:auto;
    }
    @media (prefers-color-scheme: light) {
      .log{ background:#f3f6fb; color:#22324a; }
    }
    .kbd{
      display:inline-block; border:1px solid var(--cardBorder); padding:2px 6px; border-radius:6px; font-weight:700; background:var(--card); font-size:12px;
    }
    .bestTag{
      display:inline-block; margin-left:6px; padding:2px 6px; border-radius:999px; background:rgba(96,211,148,.18); color:var(--accent); font-size:12px; font-weight:700
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <h1>åæ‡‰æ™‚é–“å°éŠæˆ²</h1>
      <div class="subtitle">çœ‹åˆ°æ–¹å¡Š <strong>å‡ºç¾</strong> æˆ– <strong>æ¶ˆå¤±</strong> çš„ç¬é–“ï¼ŒæŒ‰ä¸‹ <span class="kbd">Space</span>ï¼ˆæˆ–é»ä¸€ä¸‹ç•«é¢ï¼‰ã€‚</div>
    </div>

    <div class="board" id="app">
      <div class="stage" id="stage" aria-label="éŠæˆ²èˆå°ï¼ˆé»æ“Šå¯ä½œç­”ï¼‰">
        <div class="status" id="status">æŒ‰ã€Œé–‹å§‹ã€æˆ–æŒ‰ç©ºç™½éµé–‹å§‹</div>
        <div class="stim hidden" id="stim">æº–å‚™</div>
      </div>

      <div class="panel">
        <div class="row">
          <button class="btn primary" id="startBtn">é–‹å§‹ä¸€å›åˆ</button>
          <button class="btn" id="resetBestBtn">æ¸…é™¤æœ¬æ©Ÿæœ€ä½³</button>
        </div>

        <div class="row">
          <div class="stat">
            <div class="label">æœ¬æ¬¡æˆç¸¾</div>
            <div class="val" id="last">â€” ms</div>
          </div>
          <div class="stat">
            <div class="label">å¹³å‡ï¼ˆæœ¬å ´ï¼‰</div>
            <div class="val" id="avg">â€” ms</div>
          </div>
          <div class="stat">
            <div class="label">å›åˆæ•¸</div>
            <div class="val" id="rounds">0</div>
          </div>
          <div class="stat">
            <div class="label">æœ¬æ©Ÿæœ€ä½³</div>
            <div class="val" id="best">â€” ms</div>
          </div>
        </div>

        <div class="hint">
          æµç¨‹ï¼šæŒ‰ä¸‹ã€Œé–‹å§‹ã€â†’ é€²å…¥ç­‰å¾…ï¼ˆä¸å¯æŒ‰ï¼‰â†’ æ–¹å¡Š<em>å‡ºç¾æˆ–æ¶ˆå¤±</em> â†’ ç«‹åˆ»æŒ‰ <span class="kbd">Space</span> æˆ–é»æ“Š / è§¸æ§ã€‚<br/>
          å½èµ·è·‘ï¼ˆé‚„æ²’è®ŠåŒ–å°±æŒ‰ï¼‰æœƒè¢«åˆ¤å®šå¤±èª¤ã€‚
        </div>

        <div class="log" id="log" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // ç‹€æ…‹æ©Ÿ
      const State = {
        IDLE: 'idle',
        WAITING: 'waiting',
        READY: 'ready',       // åˆºæ¿€å·²è®ŠåŒ–ï¼Œå¯æŒ‰
        RESULT: 'result',
        FALSE: 'falseStart'
      };

      const stage = document.getElementById('stage');
      const stim  = document.getElementById('stim');
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const resetBestBtn = document.getElementById('resetBestBtn');

      const lastEl = document.getElementById('last');
      const avgEl  = document.getElementById('avg');
      const roundsEl = document.getElementById('rounds');
      const bestEl = document.getElementById('best');
      const logEl = document.getElementById('log');

      let state = State.IDLE;
      let trialStartAt = 0;      // é€²å…¥ WAITING çš„æ™‚é–“ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰
      let readyAt = 0;           // åˆºæ¿€è®ŠåŒ–çš„æ™‚é–“ï¼ˆè¨ˆæ™‚èµ·é»ï¼‰
      let timer = null;
      let currentMode = null;    // 'appear' | 'disappear'
      let results = [];          // æœ¬å ´æˆç¸¾ï¼ˆæ¯«ç§’ï¼‰
      const BEST_KEY = 'reaction_best_ms';

      // åˆå§‹åŒ–æœ¬æ©Ÿæœ€ä½³
      updateBestUI(loadBest());

      // å·¥å…·ï¼šäº‚æ•¸å»¶é²ï¼ˆ1200~3000msï¼‰
      function randomDelay() {
        return 1200 + Math.random() * 1800;
      }
      // å·¥å…·ï¼šéš¨æ©Ÿæ¨¡å¼
      function randomMode() {
        return Math.random() < 0.5 ? 'appear' : 'disappear';
      }
      // UI è¼”åŠ©
      function setStatus(msg){ statusEl.textContent = msg; }
      function setStimVisibility(show){
        stim.classList.toggle('hidden', !show);
      }
      function setStimStyle(cls){
        stim.classList.remove('ready','wait','false');
        if (cls) stim.classList.add(cls);
      }
      function log(msg){
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML = `[${time}] ${msg}<br>` + logEl.innerHTML;
      }
      function fmt(ms){
        return Math.round(ms);
      }
      function loadBest(){
        const v = localStorage.getItem(BEST_KEY);
        return v ? Number(v) : null;
      }
      function saveBest(ms){
        localStorage.setItem(BEST_KEY, String(ms));
      }
      function updateBestUI(best){
        if (best == null || !isFinite(best)) bestEl.innerHTML = 'â€” ms';
        else bestEl.innerHTML = `${fmt(best)} ms`;
      }
      function updateRoundStats(){
        roundsEl.textContent = String(results.length);
        if (results.length === 0) {
          avgEl.textContent = 'â€” ms';
        } else {
          const avg = results.reduce((a,b)=>a+b,0)/results.length;
          avgEl.textContent = `${fmt(avg)} ms`;
        }
      }

      function resetRoundUI(){
        setStimVisibility(false);
        setStimStyle(null);
        stim.textContent = 'æº–å‚™';
        setStatus('æŒ‰ã€Œé–‹å§‹ã€æˆ–æŒ‰ç©ºç™½éµé–‹å§‹');
        state = State.IDLE;
      }

      // é–‹å§‹ä¸€å›åˆ
      function startTrial(){
        if (state === State.WAITING) return; // å·²åœ¨ç­‰å¾…å°±ä¸é‡è¦†
        clearTimeout(timer);
        state = State.WAITING;
        currentMode = randomMode();
        setStimStyle('wait');

        if (currentMode === 'appear'){
          // å…ˆéš±è—ï¼Œç­‰å¾…å¾Œã€Œå‡ºç¾ã€
          setStimVisibility(false);
          setStatus('ç­‰å¾…ä¸­â€¦çœ‹åˆ°æ–¹å¡Šã€Œå‡ºç¾ã€å†æŒ‰ï¼ˆä¸å¯å…ˆæŒ‰ï¼‰');
        } else {
          // å…ˆé¡¯ç¤ºï¼Œç­‰å¾…å¾Œã€Œæ¶ˆå¤±ã€
          setStimVisibility(true);
          stim.textContent = 'æ¶ˆå¤±æ™‚æŒ‰';
          setStatus('ç­‰å¾…ä¸­â€¦çœ‹åˆ°æ–¹å¡Šã€Œæ¶ˆå¤±ã€å†æŒ‰ï¼ˆä¸å¯å…ˆæŒ‰ï¼‰');
        }

        trialStartAt = performance.now();
        timer = setTimeout(()=>{
          // é€²å…¥ READYï¼šåˆºæ¿€è®ŠåŒ–ç™¼ç”Ÿ
          state = State.READY;
          readyAt = performance.now();
          if (currentMode === 'appear'){
            setStimVisibility(true);
            stim.textContent = 'ç¾åœ¨ï¼';
          } else {
            setStimVisibility(false);
          }
          setStimStyle('ready');
          setStatus('å¿«æŒ‰ï¼ç©ºç™½éµ / é»æ“Š');
        }, randomDelay());
      }

      // å½èµ·è·‘
      function falseStart(){
        clearTimeout(timer);
        state = State.FALSE;
        setStimStyle('false');
        setStimVisibility(true);
        stim.textContent = 'å¤ªå¿«äº†ï¼';
        setStatus('å½èµ·è·‘ï¼šå°šæœªå‡ºç¾/æ¶ˆå¤±å°±æŒ‰ã€‚æŒ‰é–‹å§‹å†è©¦ä¸€æ¬¡ã€‚');
        log('å½èµ·è·‘ï¼ˆæå‰æŒ‰ä¸‹ï¼‰');
      }

      // ä½œç­”
      function answer(){
        if (state === State.WAITING){
          // é‚„æ²’è®ŠåŒ–å°±æŒ‰ï¼šå½èµ·è·‘
          falseStart();
          return;
        }
        if (state !== State.READY) return;

        const rt = performance.now() - readyAt;
        const ms = Math.max(1, rt); // å®‰å…¨ä¸‹é™
        state = State.RESULT;

        setStimStyle(null);
        setStimVisibility(true);
        stim.textContent = `${fmt(ms)} ms`;
        setStatus('æŒ‰ã€Œé–‹å§‹ã€å†ä¾†ä¸€å±€ï¼Œæˆ–ç©ºç™½éµç›´æ¥é‡ä¾†');

        results.push(ms);
        lastEl.innerHTML = `${fmt(ms)} ms` + bestBadgeIf(ms);

        // æ›´æ–°æœ¬æ©Ÿæœ€ä½³
        const best = loadBest();
        if (best == null || ms < best){
          saveBest(ms);
          updateBestUI(ms);
          log(`æ–°æœ¬æ©Ÿæœ€ä½³ï¼š${fmt(ms)} ms ğŸ‰`);
        } else {
          updateBestUI(best);
          log(`æœ¬æ¬¡ï¼š${fmt(ms)} ms`);
        }
        updateRoundStats();
      }

      function bestBadgeIf(ms){
        const best = loadBest();
        if (best == null || ms < best) {
          return ` <span class="bestTag">BEST</span>`;
        }
        return '';
      }

      // äº‹ä»¶
      startBtn.addEventListener('click', ()=>{
        if (state === State.READY){ answer(); return; }
        startTrial();
      });

      resetBestBtn.addEventListener('click', ()=>{
        localStorage.removeItem(BEST_KEY);
        updateBestUI(null);
        log('å·²æ¸…é™¤æœ¬æ©Ÿæœ€ä½³ç´€éŒ„');
      });

      // ç©ºç™½éµæ§åˆ¶ï¼šé–‹å§‹ / ä½œç­” / é‡ä¾†
      window.addEventListener('keydown', (e)=>{
        if (e.code === 'Space' || e.key === ' ') {
          e.preventDefault();
          if (state === State.IDLE || state === State.RESULT || state === State.FALSE){
            startTrial();
          } else if (state === State.WAITING){
            falseStart();
          } else if (state === State.READY){
            answer();
          }
        }
      });

      // é»æ“Š / è§¸æ§èˆå°ï¼šåŒä½œç­”è¡Œç‚º
      stage.addEventListener('pointerdown', ()=>{
        if (state === State.IDLE || state === State.RESULT || state === State.FALSE){
          startTrial();
        } else if (state === State.WAITING){
          falseStart();
        } else if (state === State.READY){
          answer();
        }
      });

      // åˆå§‹
      resetRoundUI();
      setStatus('æŒ‰ã€Œé–‹å§‹ã€æˆ–ç©ºç™½éµé–‹å§‹');
    })();
  </script>
</body>
</html>
